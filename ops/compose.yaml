services:
  traefik:
    image: traefik:v3.1
    command:
      - --providers.docker
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.le.acme.tlschallenge=true
      - --certificatesresolvers.le.acme.email=${LE_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --api.dashboard=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /opt/stack/certs:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - traefik.http.routers.dashboard.rule=Host(`${TRAEFIK_DASHBOARD_HOST}`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.tls.certresolver=le
      - traefik.http.routers.dashboard.service=api@internal
    restart: unless-stopped

  web:
    image: ghcr.io/${GITHUB_OWNER}/web:${APP_TAG}
    depends_on: [traefik]
    labels:
      - traefik.http.routers.web.rule=Host(`${WEB_HOST}`)
      - traefik.http.routers.web.entrypoints=websecure
      - traefik.http.routers.web.tls.certresolver=le
      - traefik.http.services.web.loadbalancer.server.port=80
    restart: unless-stopped

  django:
    image: ghcr.io/${GITHUB_OWNER}/django:${APP_TAG}
    env_file: /opt/stack/django/.env
    depends_on: [traefik]
    labels:
      - traefik.http.routers.api.rule=Host(`${API_HOST}`)
      - traefik.http.routers.api.entrypoints=websecure
      - traefik.http.routers.api.tls.certresolver=le
      - traefik.http.services.api.loadbalancer.server.port=8000
    restart: unless-stopped

  # Use DO Managed PG if possible; otherwise:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes: [ "pgdata:/var/lib/postgresql/data" ]
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  node_exporter:
    image: prom/node-exporter:v1.8.2
    pid: host
    network_mode: host
    command:
      - --collector.systemd
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    ports: [ "127.0.0.1:9099:8080" ]
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.55.0
    command: [ "--config.file=/etc/prometheus/prometheus.yml", "--storage.tsdb.retention.time=7d" ]
    volumes:
      - /opt/stack/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - /opt/stack/prometheus/data:/prometheus
    labels:
      - traefik.http.routers.prom.rule=Host(`${PROM_HOST}`)
      - traefik.http.routers.prom.entrypoints=websecure
      - traefik.http.routers.prom.tls.certresolver=le
      - traefik.http.services.prom.loadbalancer.server.port=9090
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.1.3
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASS}
      GF_SERVER_ROOT_URL: https://${GRAFANA_HOST}
    volumes:
      - /opt/stack/grafana/data:/var/lib/grafana
      - /opt/stack/grafana/provisioning:/etc/grafana/provisioning
    labels:
      - traefik.http.routers.grafana.rule=Host(`${GRAFANA_HOST}`)
      - traefik.http.routers.grafana.entrypoints=websecure
      - traefik.http.routers.grafana.tls.certresolver=le
      - traefik.http.services.grafana.loadbalancer.server.port=3000
    restart: unless-stopped

volumes:
  pgdata:
    driver: local
  grafanadata:
    driver: local